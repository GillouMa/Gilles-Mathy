---
title: "Mathy"
author: "Gilles Mathy"
format: html
editor: visual
---

https://github.com/GillouMa/Gilles-Mathy

```{r}
library(here)
library(readr)
```

```{r}
here::i_am("Gilles-Mathy.Rproj")
```
### Question 1
```{r}
courses <- read_csv(here("courses.csv"))
```

### Question 2

```{r}
library(dplyr)
library(knitr)

courses |>
  arrange(course) |> 
  rename(
    "course name"      = course,
    "identifier"       = course_id,
    "trimester"        = trimester,
    "number of grades" = nb_grades
  ) |>
  kable()

```

## 1.2 Students

### Question 3

```{r}
students <- read_csv(
  here("students.csv"),
  col_types = cols(
    id         = col_integer(),
    group      = col_factor(),
    birth_date = col_date(format = "%Y-%m-%d"),
    sex        = col_factor()
  )
)
```

The `birth_date` column of the `students` data frame is of class `r class(students$birth_date)`.
The `sex` column of the `students` data frame is of class `r class(students$sex)`

## 1.3 Grades

### Question 4 

```{r}
grades <- read_delim(
  here("grades.csv"),
  delim = ";",
  na = "unknown",
  col_types = cols(
    id        = col_integer(),
    course_id = col_integer(),
    grade     = col_double()
  ),
  show_col_types = FALSE
)
```

# Student Population Analysis

### Question 5

```{r}
library(ggplot2)

students <- students |>
  mutate(
    group = as.integer(as.character(group))   
  )

students_per_group <- students |>
  count(group)

ggplot(students_per_group, aes(x = factor(group), y = n)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Number of Students per Group",
    x = "Group",
    y = "Number of Students"
  ) +
  theme_minimal()
```

### Question 6

```{r}
gender_group <- students |>
  count(group, sex)

ggplot(gender_group, aes(x = factor(group), y = n, fill = sex)) +
  geom_col(position = "fill") +
  labs(
    title = "Gender Balance per Group (Proportion)",
    x = "Group",
    y = "Proportion",
    fill = "Sex"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()
```

### Question 7

```{r}
library(lubridate)

students <- students |>
  mutate(
    age = round(time_length(today() - birth_date, unit = "year"))
  )

ggplot(students, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Student Ages",
    x = "Age (years)",
    y = "Number of Students"
  ) +
  theme_minimal()
```

### Question 8

```{r}
median_age_group <- students |>
  group_by(group) |>
  summarise(
    median_age = round(median(age), 0)
  ) |>
  arrange(group)

kable(median_age_group, caption = "Median Age of Students per Group")
```

### Question 9

```{r}
oldest_per_group <- students |>
  group_by(group) |>
  slice_max(age, n = 1, with_ties = FALSE) |>   # pick the oldest student
  ungroup() |>
  select(group, id, sex, age) |>                # keep only needed columns
  arrange(desc(age))                            # sort by age decreasing

kable(oldest_per_group, caption = "Oldest Student in Each Group")
```

# 3 Simple Grade Analysis

### Question 10 

```{r}
n_grades <- sum(!is.na(grades$grade))
```

The data set contains `r n_grades` grades.

### Question 11

```{r}
crypto_id <- courses |>
  filter(course == "Cryptography and Codebreaking") |>
  pull(course_id)

crypto_group_avg <- grades |>
  filter(course_id == crypto_id, !is.na(grade)) |>   
  left_join(students, by = "id") |>                  
  group_by(group) |>
  summarise(avg_crypto = mean(grade)) |>
  arrange(group)

ggplot(crypto_group_avg, aes(x = factor(group), y = avg_crypto)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Average Grade in Cryptography and Codebreaking by Group",
    x = "Group",
    y = "Average Grade"
  ) +
  theme_minimal()
```

### Question 12

```{r}
grades_trimester <- grades |>
  left_join(courses, by = "course_id") |> 
  filter(!is.na(grade))  

ggplot(grades_trimester, aes(x = grade, color = factor(trimester), fill = factor(trimester))) +
  geom_density(alpha = 0.3) +
  labs(
    title = "Distribution of Grades by Trimester",
    x = "Grade",
    y = "Density",
    color = "Trimester",
    fill  = "Trimester"
  ) +
  theme_minimal()
```

# Attendance Analysis

### Question 13

```{r}
grades_per_student <- grades |>
  filter(!is.na(grade)) |>            
  count(id, name = "n_grades") |>     
  left_join(students, by = "id") |>   
  select(id, group, sex, n_grades) |> 
  arrange(id)

grades_per_student |>
  slice_head(n = 10) |>
  knitr::kable(caption = "First 10 Students: Number of Grades per Student")
```

```{r}
summary_stats <- grades_per_student |>
  summarise(
    minimum = min(n_grades),
    maximum = max(n_grades),
    average = mean(n_grades),
    median  = median(n_grades)
  )

knitr::kable(summary_stats, caption = "Summary Statistics of Grades per Student")
```

### Question 14

```{r}
ggplot(grades_per_student, aes(x = n_grades, color = sex, fill = sex)) +
  geom_density(alpha = 0.3) +
  labs(
    title = "Distribution of the Number of Grades by Sex",
    x = "Number of Grades",
    y = "Density",
    color = "Sex",
    fill = "Sex"
  ) +
  theme_minimal()
```

### Question 15

```{r}
car_id <- courses |>
  filter(course == "Clockwork Automata and Robotics") |>
  pull(course_id)

car_grades_per_student <- grades |>
  filter(course_id == car_id, !is.na(grade)) |>   
  count(id, name = "n_grades_car") |>             
  left_join(students, by = "id") |>               
  select(id, group, n_grades_car) |>              
  arrange(id)

car_grades_per_student |>
  slice_head(n = 10) |>
  knitr::kable(caption = "First 10 Students: Number of Grades in Clockwork Automata and Robotics")
```


### Question 16

```{r}
car_grade_distribution <- car_grades_per_student |>
  count(n_grades_car, name = "n_students") |>
  arrange(n_grades_car)

ggplot(car_grade_distribution, aes(x = factor(n_grades_car),
                                   y = n_students)) +
  geom_col(fill = "steelblue", width = 0.7) +
  geom_text(aes(label = n_students),
            vjust = -0.5,
            size = 4) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "Distribution of Number of Grades\nin Clockwork Automata and Robotics",
    x = "Number of Grades per Student",
    y = "Number of Students"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
```

### Question 17

```{r}
ggplot(car_grades_per_student,
       aes(x = factor(group), fill = factor(n_grades_car))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Share of CAR Grades per Group",
    x = "Group",
    y = "Share of Students",
    fill = "Grades"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )
```

### Question 18 

```{r}
car_grades_per_student_sex <- grades |>
  filter(course_id == car_id, !is.na(grade)) |>
  count(id, name = "n_grades_car") |>
  left_join(students, by = "id") |>
  select(id, group, sex, n_grades_car) |>
  arrange(id)

ggplot(car_grades_per_student_sex,
       aes(x = factor(group), fill = factor(n_grades_car))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ sex) +
  labs(
    title = "Share of CAR Grades per Group by Sex",
    x = "Group",
    y = "Share of Students",
    fill = "Grades"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )
```

# 5 Grade Analysis

### Question 19

```{r}
library(tidyr)

avg_grade_student_course <- grades |>
  filter(!is.na(grade)) |>
  left_join(students, by = "id") |>
  left_join(courses,  by = "course_id") |>
  group_by(id, group, course) |>
  summarise(avg_grade = mean(grade), .groups = "drop")

avg_grade_wide <- avg_grade_student_course |>
  pivot_wider(
    names_from  = course,
    values_from = avg_grade
  )

avg_grade_wide |>
  select(
    id,
    group,
    `Airship Piloting and Navigation`,
    `Alchemy and Chemical Engineering`
  ) |>
  slice_head(n = 5) |>
  kable(caption = "Average grades per student (extract with two courses)")
```

### Question 20

```{r}
two_courses <- avg_grade_wide |>
  select(
    id,
    `Historical Archaeology and Antiquarian Studies`,
    `Etiquette and Social Graces`
  ) |>
  rename(
    hist = `Historical Archaeology and Antiquarian Studies`,
    etiqu = `Etiquette and Social Graces`
  ) |>
  tidyr::drop_na(hist, etiqu)

ggplot(two_courses, aes(x = etiqu, y = hist)) +
  geom_point(alpha = 0.5, size = 2.2, color = "steelblue") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred", linetype = "dashed") +
  labs(
    title = "Relationship Between Course Averages",
    subtitle = "Historical Archaeology and Antiquarian Studies (HAAS) vs Etiquette and Social Graces",
    x = "Average Grade in Etiquette and Social Graces",
    y = "Average Grade in HAAS"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    panel.grid.minor = element_blank()
  )
```

###Question 21

```{r}
correlations_by_group <- avg_grade_wide %>%
  group_by(group) %>%
  summarise(
    correlation = cor(`Fashion Design and Textile Innovation`,
                      `Electrical Engineering and Telegraphy`,
                      use = "complete.obs")
  )

correlations_by_group %>%
  slice_head(n = 10) %>%
  knitr::kable(digits = 3)
```

### Question 22

```{r}
target_group <- correlations_by_group |>
  slice_max(abs(correlation)) |>
  pull(group)

data_q22 <- avg_grade_wide |>
  filter(group == target_group)

ggplot(data_q22, aes(
  x = `Electrical Engineering and Telegraphy`,
  y = `Fashion Design and Textile Innovation`
)) +
  geom_point(alpha = 0.7, size = 2) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linewidth = 1) +
  labs(
    title = paste(
      "Fashion vs Electrical Grades in Group", target_group
    ),
    x = "Average Grade in Electrical Engineering and Telegraphy",
    y = "Average Grade in FDTI"
  ) +
  theme_minimal(base_size = 14)
```

### Question 23

```{r}
course_cols <- names(avg_grade_wide)[
  !(names(avg_grade_wide) %in% c("id", "group"))
]

final_grade_df <- avg_grade_wide |>
  rowwise() |>
  mutate(final_grade = mean(c_across(all_of(course_cols)))) |>
  ungroup()

final_grade_df <- final_grade_df |>
  left_join(students |> select(id, sex), by = "id") |>
  select(id, group, sex, final_grade)

final_grade_df <- final_grade_df |>
  arrange(desc(final_grade))

final_grade_df |>
  slice_head(n = 5) |>
  knitr::kable()
```


### Question 24






















